import{registerUser}from"./registerUser.js";import apiUrl from"../helpers/apiUrl.js";import getUserData from"../helpers/getUserData.js";export const getCheckoutFlow=(a,b,c)=>{let d,e;getUserData(a=>{a&&a.email&&a.id?chrome.windows.create({url:`${apiUrl}/plus/checkout/${a.id}`,type:"popup",height:700,width:500,state:"normal"},a=>{d=a.id,e=a.tabs[0].id}):chrome.windows.create({url:`${apiUrl}/auth/`,type:"popup",height:700,width:500,state:"normal"},a=>{d=a.id,e=a.tabs[0].id})}),chrome.tabs.onUpdated.addListener(()=>{chrome.tabs.get(e,a=>{if(a.url.includes("/plus/thanks")&&(chrome.windows.remove(d),c("paymentSucceeded")),a.url.includes("/plus/error")&&registerUser(),a.url.includes("/auth/success"))try{const b=JSON.parse(atob(a.url.split("/").pop()));b&&b.email&&b.id&&chrome.storage.sync.set({userData:b},()=>{chrome.tabs.update(e,{url:`${apiUrl}/plus/checkout/${b.id}`})})}catch(a){}})}),chrome.windows.onRemoved.addListener(a=>{a===d&&c("windowClosed")})};