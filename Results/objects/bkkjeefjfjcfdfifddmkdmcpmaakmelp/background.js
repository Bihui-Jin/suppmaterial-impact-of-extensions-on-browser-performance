import { r as r$1 } from './chunks/parse_token.util-d707319f.js';
import { e as e$1 } from './chunks/mui-theme-82489cf1.js';
import { t, e } from './chunks/constants-4d4688da.js';
import { n } from './chunks/router.interface-3a81c163.js';
import { s, m as m$1 } from './chunks/storage-e7df8ba2.js';

class r extends Error{constructor(e,t){super(t),this.code=e,this.message=t;}}const c=(e,t={},n)=>({body:t,meta:{isSuccess:!1,code:e,nonce:n}});async function l(e,n,{expireSeconds:o=t.ONE_MINUTE_SECONDS}={}){const s=await m$1.cache.get(e);let i,r;const c=(null==s?void 0:s.expiresAt)<Date.now();if((null==s?void 0:s.value)&&!c)i=s.value,r=!0;else {i=await n(),r=!1;const s=Date.now()+o*t.ONE_SECOND_MS;await m$1.cache.set(e,{expiresAt:s,value:i});}return {value:i,isCached:r}}async function u(e){await m$1.cache.remove(e);}const d=(e,t)=>`${e}:${t}`;function h(e,t){const n=function(e){if(null==e?void 0:e.nodes)return e.nodes.map((e=>{if(e)return function(e){var t,n,a,s,i;return {id:null===(t=null==e?void 0:e.collectible)||void 0===t?void 0:t.id,name:null===(n=null==e?void 0:e.collectible)||void 0===n?void 0:n.slug,ext:null===(i=null===(s=null===(a=null==e?void 0:e.collectible)||void 0===a?void 0:a.fileRel)||void 0===s?void 0:s.fileObj)||void 0===i?void 0:i.ext,provider:e$1.Spore}}(e)})).filter(p);return []}(null==t?void 0:t.ownedCollectibleConnection),a=(s=null==t?void 0:t.ownedCollectibleConnection,null===(i=null==s?void 0:s.nodes)||void 0===i?void 0:i.map((e=>{var t;return null===(t=null==e?void 0:e.collectible)||void 0===t?void 0:t.slug})));var s,i;const r=function(e){var t;return null===(t=null==e?void 0:e.nodes)||void 0===t?void 0:t.map((e=>{var t;return null===(t=null==e?void 0:e.powerup)||void 0===t?void 0:t.slug}))}(null==t?void 0:t.activePowerupConnection),c=function(e){var t;const n=null===(t=null==e?void 0:e.keyValueConnection.nodes.find((e=>"subbedMonths"===e.key)))||void 0===t?void 0:t.value;return n?parseInt(n):0}(t),l=function(e){var t;return null===(t=null==e?void 0:e.keyValueConnection.nodes.find((e=>"nameColor"===e.key)))||void 0===t?void 0:t.value}(t);return {id:e,emotes:a,badges:r,name:null==t?void 0:t.user.name,subbedMonths:c,nameColor:l,serializedEmotes:n}}const p=e=>!!e;async function v(e,t,n,{throwIfErrors:o}={}){var a;const s=await fetch(e,{method:"POST",headers:{Authorization:"Bearer pk_U1x92ZrrdQoflf2JycecdmnilAGRAkmUNBpxPnVPDdeUKcsH","Content-Type":"application/json"},body:JSON.stringify({query:t,variables:n})}),i=await s.json();if(o&&(null===(a=i.data)||void 0===a?void 0:a.errors))throw new Error(`spore graphql error ${i.data.errors}`);return i.data}let g;const y=e=>s.cookies.getAll({url:e}).then((e=>e.filter((e=>!e.name.startsWith("ST-"))).map((e=>[e.name,e.value])))).then(Object.fromEntries),w={"@me":async()=>{const e=await m$1.auth.get("token");return r$1(e)},token:async()=>await m$1.auth.get("token"),logout:async()=>{const e=await m$1.auth.get("token");await fetch("https://v2.truffle.vip/auth/youtube",{method:"DELETE",headers:{Authorization:`Bearer ${e}`}}),await m$1.auth.remove("token");},login:async e=>{const n=await y(e.href),o=await async function(e,t){const n={cookies:e,request:t};try{return await v("https://zygote.spore.build/graphql","mutation MogulTVYoutubeLogin($cookies: JSON, $request: JSON) {\n\t\tmogulTvYoutubeLogin(cookies: $cookies, request: $request)\n}",n)}catch(e){console.error(e);}}(n,e),a=null==o?void 0:o.mogulTvYoutubeLogin;if(a)return await m$1.auth.set("token",a),r$1(a)},link:async e=>{const n=await m$1.auth.get("token"),o=await fetch(`https://v2.truffle.vip/link/${e}`,{method:"GET",headers:{Authorization:`Bearer ${n}`}});if(200!==o.status)return;const a=await o.text();await chrome.cookies.set({url:"https://v2.truffle.vip",name:"Authorization",value:n,httpOnly:!0,path:`/link/${e}/callback`,expirationDate:Math.floor(Date.now()/1e3)+3600}),await chrome.windows.create({url:a,focused:!0,type:"popup",width:850,height:800});const s=await new Promise((e=>{g=e;}));return m$1.auth.set("token",s),r$1(s)},"finish-link":async(e,t)=>{var o,a;(null===(o=t.sender.tab)||void 0===o?void 0:o.id)&&s.tabs.remove(null===(a=t.sender.tab)||void 0===a?void 0:a.id),null==g||g(e);},"get-access-token":()=>m$1.auth.get("accessToken"),"set-access-token":async e=>{await m$1.auth.set("accessToken",e);},"disconnect-link":async e=>{const n=await m$1.auth.get("token"),o=await fetch(`https://v2.truffle.vip/link/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${n}`}});if(200!==o.status)return;const{jwt:a}=await o.json();return await m$1.auth.set("token",a),r$1(a)}},f=[{youtubeChannelId:"UCrPseYLGpNygVi34QpGNqpA",displayName:"ludwig",login:"ludwig"},{youtubeChannelId:"UCNF0LEQ2abMr0PAX3cfkAMg",displayName:"DrLupo",login:"drlupo"},{youtubeChannelId:"UCvWU1K29wCZ8j1NsXsRrKnA",displayName:"LilyPichu",login:"lilypichu"},{youtubeChannelId:"UCvQczq3aHiHRBGEx-BKdrcg",displayName:"Myth",login:"myth"}];async function m(e){try{const t=await fetch(`https://youtube.com/channel/${e.youtubeChannelId}/live`);if(200!==t.status)return null;const n=await t.text(),o=/(?:window\s*\[\s*["']ytInitialData["']\s*\]|ytInitialData)\s*=\s*({.+?})\s*;/.exec(n);if(o){const t=JSON.parse(o[1]),n=t.currentVideoEndpoint.watchEndpoint.videoId,a=t.contents.twoColumnWatchNextResults.results.results.contents[0].videoPrimaryInfoRenderer,s=t.contents.twoColumnWatchNextResults.results.results.contents[1].videoSecondaryInfoRenderer.owner.videoOwnerRenderer.thumbnail.thumbnails[0].url,i=a.viewCount.videoViewCountRenderer.viewCount.runs.find((e=>/^[0-9,]+$/.test(e.text))).text;return {title:a.title.runs[0].text,viewersCount:parseInt(i.replace(/,/g,"")),previewImageURL:`https://i.ytimg.com/vi/${n}/mqdefault.jpg`,profileImageURL:s,displayName:e.displayName,login:e.login,twitchId:e.youtubeChannelId}}}catch(e){console.warn(e);}return null}const b={"get-stream":async e=>{const n=await m$1.cache.get("get-stream");let o;if(n&&n.expiresAt>Date.now())o=n.value;else {const n=Date.now()+6e4,a=f.find((t=>t.youtubeChannelId===e));if(!a)return null;o=await m(a),await m$1.cache.set("get-stream",{expiresAt:n,value:o});}return o},"get-streams":async()=>{const e=await m$1.cache.get("get-streams");let n;if(e&&e.expiresAt>Date.now())n=e.value;else {const e=Date.now()+6e4;n=await Promise.all(f.map((async e=>await m(e)))),await m$1.cache.set("get-streams",{expiresAt:e,value:n});}return n},"get-user":async e$1=>{const t=await y(e$1.href),n=await e(Object.assign(Object.assign({},e$1),{cookies:t}));if(!n.success)throw new r(n.code,n.message);return n.data},"set-watched-channel":async e=>{const n=await m$1.watchedChannels.get("channels");n.includes(e)||(n.push(e),await m$1.watchedChannels.set("channels",n));},"get-watched-channels":async()=>m$1.watchedChannels.get("channels")},C={users:async e=>{if(!e)return "[]";const t=`https://v2.truffle.vip/gateway/users/v2/c/${e}`;return (await fetch(t)).text()},emotes:async e=>{const t="https://v2.truffle.vip/gateway/emotes",n=e?`${t}/c/${e}`:t;return (await fetch(n)).text()},badges:((e,{cacheExpirationMs:n=t.ONE_SECOND_MS,cacheControlFallback:o=t.FIVE_MINUTE_SECONDS}={})=>async()=>(async(e,{cacheExpirationMs:n=t.ONE_SECOND_MS,cacheControlFallback:o=t.FIVE_MINUTE_SECONDS}={})=>{var s,i;const r=await m$1.cache.get(e);let c;if(r&&r.expiresAt>Date.now())c=r.value;else {const a=await fetch("https://v2.truffle.vip"+e),r=Number(a.headers.get("age")),l=Number((null===(i=null===(s=a.headers.get("cache-control"))||void 0===s?void 0:s.match(/max-age=(\d+)/))||void 0===i?void 0:i[1])||o)-r,u=Date.now()+l*n;c=await a.json(),await m$1.cache.set(e,{expiresAt:u,value:c});}return c})(e,{cacheControlFallback:o,cacheExpirationMs:n}))("/gateway/badges"),"set-settings":async e=>{const n=await m$1.auth.get("token"),o=await fetch("https://v2.truffle.vip/gateway/settings",{method:"PUT",headers:{Authorization:`Bearer ${n}`},body:JSON.stringify(e)}),{jwt:a}=await o.json();return m$1.auth.set("token",a),r$1(a)}},I={youtube:b,gateway:C,auth:w,extension:{popup:()=>s.action.openPopup(),"open-tab":async e=>{await s.tabs.create({url:e});}},spore:{"invalidate-spore-user-cache":async({connectionSourceId:e,sporeOrgId:t}={})=>u(d(e,t)),"fetch-spore-user":async({connectionSourceId:e,sporeOrgId:t,invalidateCache:n=!1}={})=>{const o=d(e,t);return n&&await u(o),l(o,(async()=>{const n=await async function(e,t){const n={sourceType:"youtube",sourceId:e,collectibleType:"emote",orgId:t};try{return (await v("https://zygote.spore.build/graphql","query CacheableConnectionCollectiblesPowerupsConnectionBySourceAndOrg (\n    $sourceType: String, $sourceId: String, $collectibleType: String!, $orgId: ID)\n    {\n        connection(sourceType: $sourceType, sourceId: $sourceId, orgId: $orgId) {\n          id\n          orgId\n          userId\n          sourceType\n          sourceId\n          secondarySourceId\n          orgUser {\n            id\n            userId\n            orgId\n\t\t\t\t\t\tkeyValueConnection {\n\t\t\t\t\t\t\tnodes {\n\t\t\t\t\t\t\t\tkey\n\t\t\t\t\t\t\t\tvalue\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t\tuser {\n\t\t\t\t\t\t\tname\n\t\t\t\t\t\t}\n            ownedCollectibleConnection(collectibleType: $collectibleType) {\n                nodes {\n                    userId\n                    collectible {\n                        id\n                        name\n                        slug\n                        fileRel {\n                            fileObj {\n                                src\n                                ext\n                            }\n                        }\n                    }\n                }\n            }\n            activePowerupConnection {\n                totalCount\n                nodes {\n                    id\n                    userId\n                    data {\n                            rgba\n                        }\n                    powerup {\n                        id\n                        slug\n\n                        componentRels {\n                            props\n                        }\n                    }\n                }\n            }\n        }\n    }\n}",n)).connection}catch(e){console.error(e);}}(e,t);return h(e,null==n?void 0:n.orgUser)}),{expireSeconds:60})},"fetch-youtube-channel":async e=>{const t=(e=>`spore-org-yt-channel:${e}`)(e);return l(t,(()=>async function(e){const t={id:e};try{return (await v("https://zygote.spore.build/graphql","query YoutubeChannelById($id: String) {\n\tyoutubeChannel(id: $id) {\n\t\tid\n\t\tsporeOrgId\n\t\tchannelName\n\t\tisLive\t\n\t\tseasonPass {\n\t\t\tname\n\t\t}\n\t}\n}",t)).youtubeChannel}catch(e){console.error(e);}}(e)),{expireSeconds:60})},"fetch-max-super-chat-cents":async e=>{const t=(e=>`spore-org-config:${e}`)(e);return l(t,(async()=>{var t,n;const o=await async function(e){const t={orgId:e};try{return (await v("https://zygote.spore.build/graphql","query OrgConfigByOrgId($orgId: ID) {\n\torgConfig(orgId: $orgId) { data }\n}",t)).orgConfig}catch(e){console.error(e);}}(e);return null===(n=null===(t=null==o?void 0:o.data)||void 0===t?void 0:t.youtubeSettings)||void 0===n?void 0:n.maxSuperChatCents}),{expireSeconds:60})},"fetch-is-experimental-enabled":async()=>m$1.settings.get("experimental"),"fetch-is-twitch-following-enabled":async()=>m$1.settings.get("twitchFollowing")}},k=async(t,n$1)=>{var o;const{path:a,body:s}=t;if(!a)return;t.meta?t.meta.sender=n$1:t.meta={sender:n$1,isPort:!1},t.meta.isPort||(t.meta.isPort=!1);const i=e=>{},r=a.split("/").filter(Boolean),l=r[0];if(!(l in I)){return c(n.NotFound,void 0,t.nonce)}const u=I[l][r.slice(1).join("/")];if(!u){return c(n.NotFound,void 0,t.nonce)}try{const n$1=((t,n$1)=>({body:t,meta:{isSuccess:!0,code:n.Success,nonce:n$1}}))(await u(s,t.meta),t.nonce);return i(n$1),n$1}catch(n$1){const a=n$1;return c(null!==(o=a.code)&&void 0!==o?o:n.Unknown,{message:a.message},t.nonce)}};s.runtime.setUninstallURL("https://truffle.vip/extension-survey"),s.runtime.onConnect.addListener((e=>{const t=e.sender;t&&(e.onMessage.addListener((async n=>{n.meta={isPort:!0};const o=await k(n,t);e.postMessage(o);})),s.tabs.onUpdated.addListener(((t,n,o)=>{e.postMessage({type:"tab:updated",tabId:t,changeInfo:n,tab:o});})));})),s.runtime.onMessage.addListener(k);
