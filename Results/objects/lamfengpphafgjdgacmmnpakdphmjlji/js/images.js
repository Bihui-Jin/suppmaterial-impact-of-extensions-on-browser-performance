var CONFIG={ITEM_W:260,ITEM_H:240};var Downloader={cacheImages:[],srcHash:{},queueImages:[],widthSlider:null,heightSlider:null,fileTypeCombo:null,sortCombo:null,init:function(){var t=this;var config=Config.getAll();MyLibs.trace('config: ');MyLibs.trace(config);t.widthSlider=$('#widthRange').slider({id:'widthRange',min:0,max:1000,range:true,tooltip:'hide',value:config.widthRange});t.heightSlider=$('#heightRange').slider({id:'heightRange',min:0,max:1000,range:true,tooltip:'hide',value:config.heightRange});t.fileTypeCombo=$('#fileType');t.sortCombo=$('#sort');$('#fileType option').filter(function(){return $(this).val()==config.fileType}).attr('selected',true);$('#sort option').filter(function(){return $(this).val()==config.sortType}).attr('selected',true);t.showSliderLabel(t.widthSlider);t.showSliderLabel(t.heightSlider);t.widthSlider.on('slide',function(event){t.showSliderLabel(t.widthSlider);});t.widthSlider.on('slideStop',function(event){Config.setWidthRange(t.widthSlider.slider('getValue'));t.filterChanged();});t.heightSlider.on('slide',function(event){t.showSliderLabel(t.heightSlider);});t.heightSlider.on('slideStop',function(event){Config.setHeightRange(t.heightSlider.slider('getValue'));t.filterChanged();});t.fileTypeCombo.change(function(){Config.setFileType(t.fileTypeCombo.val());t.filterChanged();});$('#btn-folder').click(function(){if(Config.getAlertDownloadAsk()==1){$('#alertDialog').modal();return;}
t.saveSelectedToFolder();});$('#btn_alertDownloadAskOk').click(function(){$('#alertDialog').modal('hide');if($('#chk_alertDownloadAsk').prop('checked')){Config.setAlertDownloadAsk(0);}
t.saveSelectedToFolder();});$('#list').on('click','li',function(e){var obj=$(this);if(obj.hasClass("selected"))
obj.removeClass('selected');else
obj.addClass('selected');t.showNum();});$('#sort').change(function(){Config.setSortType(t.sortCombo.val());t.sortTypeChanged();});$('#btn_invert').click(function(){$('#list > li').each(function(index,obj){if($(this).hasClass('selected'))
$(this).removeClass('selected');else
$(this).addClass('selected');t.showNum();});});$("#linkChromeDownloadsSetting").click(function(){chrome.tabs.create({url:"chrome://settings/search#"+chrome.i18n.getMessage("download_settings_save_confirm_key")});});$('#progressBar').hide();t.clear();setInterval(t.processQueue,80);},beforeLoad:function(){var t=this;$('#progressCount').html(t.queueImages.length);$('#progressBar').show();},afterLoad:function(){var t=this;if(t.queueImages.length==0){$('#progressBar').hide();}},processQueue:function(){var t=Downloader;var img=t.queueImages.shift();if(img==undefined)
return;t.beforeLoad();var imgObj=new Image();imgObj.onload=function(){img.width=parseInt(this.naturalWidth);img.height=parseInt(this.naturalHeight);t.addImageList([img],true);t.afterLoad();};imgObj.onerror=function(){t.afterLoad();};imgObj.src=img.src},showNum:function(){$('#totalNum').html(this.cacheImages.length);$('#showNum').html($('#list').find('.selected').length);},showSliderLabel:function(obj){var labelId=obj.attr('id')+'Label';var value=obj.slider('getValue');var text=value[0]+'px';if(value[1]>=1000)
text+=' ~ inf';else
text+=' ~ '+value[1]+'px';$('#'+labelId).html(text);},clear:function(){$('#list').html('');},addImageList:function(images,checkUnique){var t=this;images.forEach(function(img){if(img.width==0||img.height==0){img.index=t.queueImages.length+t.cacheImages.length;t.queueImages.push(img);}
else{if(checkUnique){if(t.srcHash[img.src]==undefined){t.srcHash[img.src]=1;img.index=t.queueImages.length+t.cacheImages.length;t.cacheImages.push(img);}
else{return;}}
t.addToUIList(img);}
t.showNum();});t.sortTypeChanged();},isFilterOk:function(img){var wr=this.widthSlider.slider('getValue');var hr=this.heightSlider.slider('getValue');var filetype=this.fileTypeCombo.val();if((wr[0]>0&&img.width<wr[0])||(wr[1]<1000&&img.width>wr[1])||(hr[0]>0&&img.height<hr[0])||(hr[1]<1000&&img.height>hr[1])){return false;}
if(filetype!=undefined&&filetype.length>0&&filetype!='all'){if(filetype=='jpg'||filetype=='png'||filetype=='gif'){filetype='.'+filetype;if(img.src.isEndWith(filetype)==false){return false;}}
else{if(img.src.isEndWith('.jpg')!=false||img.src.isEndWith('.png')!=false||img.src.isEndWith('.gif')!=false){return false;}}}
return true;},filterChanged:function(){this.clear();this.addImageList(this.cacheImages,false);this.sortTypeChanged();},getFileType:function(url){var pos=url.lastIndexOf('.');if(pos>1){var ext=url.substr(pos+1);if(ext.length==3)
return ext;}
return'';},addToUIList:function(img){if(this.isFilterOk(img)==false)
return;var wrate=img.width/CONFIG.ITEM_W;var hrate=img.height/CONFIG.ITEM_H;var rate=Math.max(1,Math.max(wrate,hrate));var w=img.width/rate;var h=img.height/rate;var top=Math.floor((CONFIG.ITEM_H-h)/2);var left=Math.floor((CONFIG.ITEM_W-w)/2);top=Math.max(0,top);left=Math.max(0,left);var temp='<li class="selected"><img src="{0}" style="top:{1}px !important; left:{2}px !important;" data-w="{3}" data-h="{4}" data-area="{5}" data-type="{6}" data-index="{7}" title="Click to check or uncheck" />'+'<div class="info"><span class="label label-success size">{3}x{4}</span> <span class="label label-info type">{6}</span></div></li>';var html=temp.format(img.src,top,left,img.width,img.height,img.width*img.height,this.getFileType(img.src).toUpperCase(),img.index);$('#list').append(html);},sortTypeChanged:function(){var t=this;var term=t.sortCombo.val().split(',');t.sort(term[0],term[1]);},sort:function(field,ord){$("#list > li").tsort("img",{data:field,order:ord});},saveSelectedToFolder:function(){MyLibs.trace('saveSelectedFolder');$('#list li.selected img').each(function(index,img){var filename=Downloader.getFileNameWithUrl(img.src);chrome.downloads.download({url:img.src,filename:filename,saveAs:false,conflictAction:"uniquify"});});},getFileNameWithUrl:function(url){var pos=url.lastIndexOf('/');var out=url.substr(pos+1,url.length);pos=out.lastIndexOf('?');if(pos>=0)
out=out.substr(0,pos);if(out.lastIndexOf('.')<0)
out+='.jpg';return out;}};$(function(){chrome.extension.onMessage.addListener(function(request){MyLibs.trace('[RECV] '+request.action);if(request.action=='IMAGELIST_LOAD'){MyLibs.trace(request.images.length);Downloader.addImageList(request.images,true);}})
Downloader.init();});

