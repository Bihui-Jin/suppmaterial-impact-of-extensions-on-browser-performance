import{d as D}from"./seventv.useModule.3.0.4.js";import{e as C,aq as T,a as F,at as E,aK as j,U as k,l as L,f as B,k as I,F as N,u as R,x as $}from"./seventv.useSettings.3.0.4.js";import{C as O}from"./seventv.ChatMessage.3.0.4.js";import{u as w}from"./seventv.useChannelContext.3.0.4.js";import{u as x}from"./seventv.useChatEmotes.3.0.4.js";import{r as A,ab as V,u as M}from"./seventv.useUserAgent.3.0.4.js";function q(y){var o,s;return((s=(o=atob(decodeURIComponent(atob(y))).split(`*'
`))==null?void 0:o[1].split("\v"))==null?void 0:s[0])??""}const P=C({__name:"ChatAutocomplete",async setup(y){let o,s;const f=w(),i=x(f),a=([o,s]=T(()=>customElements.whenDefined("yt-live-chat-text-input-field-renderer")),o=await o,s(),o),n=new a,t=A([]);return F(i.active,()=>{t.value=[...[i.byProvider("7TV"),i.byProvider("BTTV"),i.byProvider("FFZ")].flatMap(e=>Object.values(e).flatMap(u=>u.emotes))]}),E(n.constructor.prototype,"getSuggestions",function(e,u){const h=e==null?void 0:e.apply(this,[u]);if(!h||!Array.isArray(h))return;const m=u.toLowerCase().slice(1),d=t.value.filter(l=>l.name.toLowerCase().includes(m));return h.push(...d.map(l=>{var b;return{suggestion:{alt:l.name,emoji:!0,text:l.name,textToInsertWhenSelected:l.name,image:{accessibility:{accessibilityData:{label:l.name}},thumbnails:(b=l.data)==null?void 0:b.host.files.filter(p=>p.format===l.data.host.files[0].format).map(p=>({url:`${l.data.host.url}/${p.name}`,width:p.width,height:p.height}))}}}})),h}),(e,u)=>null}}),S=C({__name:"ChatData",setup(y){const o=w(),s=x(o),f=V(o,"id"),i=j(()=>k.channels.where("id").equals(o.id??"").first().then(a=>(a==null?void 0:a.set_ids)??[]),()=>{s.providers["7TV"]={},s.providers.FFZ={},s.providers.BTTV={}},{reactives:[f]});return j(()=>k.emoteSets.where("id").anyOf(i.value??[]).or("scope").equals("GLOBAL").sortBy("priority"),a=>{if(!a)return;for(const t of a){const e=t.provider??"UNKNOWN";s.providers[e]||(s.providers[e]={}),s.providers[e][t.id]=t,s.sets[t.id]=t}const n={};for(const t of a.flatMap(e=>e.emotes)){if(!t)return;n[t.name]=t}for(const t in s.emojis){const e=s.emojis[t];!e||!e.unicode||(n[e.unicode]=e)}for(const t in n)s.active[t]=n[t]},{reactives:[i]}),(a,n)=>null}}),U=C({__name:"ChatController",props:{channelId:null,chatList:null},setup(y){const o=y,s=w(o.channelId),f=x(s),i={};return E(o.chatList.constructor.prototype,"handleAddChatItemAction_",function(a,n){var p;if(!n||!n.item||!((p=n.item.liveChatTextMessageRenderer)!=null&&p.message))return a==null?void 0:a.apply(this,[n]);const t=new O(n.clientId??n.clientMessageId??"");for(const r of n.item.liveChatTextMessageRenderer.message.runs)if(r.text)t.body+=r.text;else if(r.emoji){const c=r.emoji.image.accessibility.accessibilityData.label;t.body+=c,i[c]||(i[c]={id:r.emoji.emojiId,name:c,data:{id:r.emoji.emojiId,name:c,owner:null,host:{url:"",files:r.emoji.image.thumbnails.map(_=>({name:_.url,width:_.width,height:_.height,format:"PNG"}))}}})}const e=n.item.liveChatTextMessageRenderer.message.runs;e.length=0;const u=t.getTokenizer(),h=(u==null?void 0:u.tokenize({emoteMap:{...f.active,...i},chatterMap:{}}))??[],m=[],d=t.body;let l=0;for(const r of h){const c=r.range[0],_=r.range[1],v=d.substring(l,c);v&&m.push(v),m.push(r),l=_+1}const b=d.substring(l);b&&m.push(b);for(const r of m){if(typeof r=="string"){e.push({text:r});continue}switch(r.kind){case"EMOTE":{const c=r.content;if(!c.emote||!c.emote.data)break;const _=!i[c.emote.name],v=c.emote.data.host;e.push({emoji:{emojiId:_?`seventv:${c.emote.id}`:c.emote.id,image:{accessibility:{accessibilityData:{label:c.emote.name}},thumbnails:v.files.filter(g=>g.format===v.files[0].format).slice(0,2).map(g=>({url:v.url?`${v.url}/${g.name}`:g.name,width:g.width,height:g.height}))},isCustomEmoji:!0}});break}}}return a==null?void 0:a.apply(this,[n])}),(a,n)=>(L(),B(N,null,[I(S),I(P)],64))}});const Q=C({__name:"ChatModule",async setup(y){let o,s;const{markAsReady:f}=D("chat",{name:"Chat",depends_on:[]}),i=A(""),a=([o,s]=T(()=>customElements.whenDefined("yt-live-chat-item-list-renderer")),o=await o,s(),o),n=new a;async function t(){var m;await customElements.whenDefined("yt-live-chat-message-input-renderer");const e=document.querySelector("yt-live-chat-message-input-renderer");if(!e){const d=window.yt;i.value=((m=d==null?void 0:d.config_)==null?void 0:m.CHANNEL_ID)??"";return}const u=e.data.sendButton.buttonRenderer.serviceEndpoint.sendLiveChatMessageEndpoint.params,h=q(u);i.value=h}return t(),f(),(e,u)=>M(n)&&i.value?(L(),R(U,{key:0,"chat-list":M(n),"channel-id":i.value},null,8,["chat-list","channel-id"])):$("",!0)}});export{Q as _};
