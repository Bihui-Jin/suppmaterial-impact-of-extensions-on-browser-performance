import{e as O,az as L,at as P,a as H,a2 as R,as as N,l as h,f as b,F as v,q as U,u as T,j as I,k as j,$ as F,x as D,aw as G,_ as K,H as $,i as z,ak as Y,aE as q,au as W,ar as X}from"./seventv.useSettings.3.0.4.js";import{R as J,u as A}from"./seventv.ReactHooks.3.0.4.js";import{d as Q}from"./seventv.useModule.3.0.4.js";import{r as B,l as Z,t as ee,u,a as te}from"./seventv.useUserAgent.3.0.4.js";import{c as oe,a as se}from"./seventv.Transform.3.0.4.js";import{C as ne,M as C}from"./seventv.ChatMessage.3.0.4.js";import{u as re}from"./seventv.useChannelContext.3.0.4.js";import{u as ae}from"./seventv.useChatEmotes.3.0.4.js";import{u as ce,U as ie}from"./seventv.index.3.0.4.js";import{_ as le,i as pe}from"./seventv.index.3.0.42.js";const me={class:"seventv-chat-vod-message-wrapper"},ue={class:"seventv-chat-vod-message-timestamp"},de=O({__name:"ChatVod",props:{list:null,controller:null},setup(w){const i=w,y=re(),d=ae(y),a=ce(y),g=B([]);L(i.controller.component,"props",{value(e){var n,l;const{owner:o}=e.data.video??{},s=e.data.badges;let t=null;if(o&&(y.setCurrentChannel({id:o.id,username:o.login,displayName:o.login}),t=o.broadcastBadges),e.data.badges&&!((n=a.twitchBadgeSets)!=null&&n.globalsBySet)&&!((l=a.twitchBadgeSets)!=null&&l.channelsBySet)){a.twitchBadgeSets={globalsBySet:new Map,channelsBySet:new Map,count:0};for(const p of[...s,...t??[]]){let m=a.twitchBadgeSets.globalsBySet.get(p.setID);m||(m=new Map,a.twitchBadgeSets.globalsBySet.set(p.setID,m),a.twitchBadgeSets.count++),m.set(p.version,p)}}(e.canCurrentUserBan||e.canCurrentUserDelete)&&(a.showModerationIcons=!0,a.isModerator=!0)}}),P(i.list.component,"render",function(e){const o=e==null?void 0:e.apply(this);let t=o.props.children,n=0;for(;!(n++>25);)if(Array.isArray(t)?t=t[0]:t&&(t=t.props.children),t&&!Array.isArray(t)&&t.type==="ul"){t.props.children=c(t.props.children);break}return o}),H(g.value,()=>{!i.list.component||typeof i.list.component.componentDidUpdate!="function"||i.list.component.componentDidUpdate(i.list.component.props,i.list.component.state)});function E(e){return e&&e.badgeSets&&e.canCurrentUserBan!==void 0&&e.canCurrentUserDelete!==void 0&&e.messageContext&&e.messageContext.author&&e.messageContext.comment&&e.messageContext.lastUpdated}function c(e){var s,t;const o=[];g.value.length=0;for(let n=0;n<e.length;n++){const l=e[n];if(!l)continue;const p=l.props;if(!p)continue;const m=p.children;if(!m)continue;const k=(t=(s=m.props)==null?void 0:s.children)==null?void 0:t.props;if(!E(k))continue;const f=S(k);l.props.children=f.element,o[n]=l,g.value[n]={current:te(f.element.ref),msg:f.msg,timestamp:f.timestamp}}return o}function S(e){var f,x,M,V;const o=B({current:null}),s=e.messageContext.comment,t=new ne(e.messageContext.comment.id);e.messageContext.author&&(t.setAuthor({id:e.messageContext.author.id,username:e.messageContext.author.name??"",displayName:e.messageContext.author.displayName??"",color:s.message.userColor}),t.badges=s.userBadges);for(const _ of s.message.tokens)switch(_.type){case C.EMOTE:{const r=_.content;if(!r.alt)continue;t.nativeEmotes[r.alt+(r.cheerAmount??"")]={id:r.emoteID??"",name:r.alt,flags:0,provider:"TWITCH",isTwitchCheer:{amount:r.cheerAmount,color:r.cheerColor},data:r.cheerAmount?oe({alt:r.alt,cheerAmount:r.cheerAmount,cheerColor:r.cheerColor,images:r.images}):se({id:r.emoteID,token:r.alt})},t.body+=r.alt;break}case C.MENTION:t.body+=`@${_.content.recipient}`;break;case C.TEXT:case C.CURRENTUSERHIGHLIGHT:t.body+=_.content;break;case C.LINK:case C.CLIPLINK:case C.VIDEOLINK:t.body+=_.content.url;break}const n=pe({start:0,end:s.contentOffset*1e3}),l=n.days?(f=n.days)==null?void 0:f.toString().padStart(2,"0"):"",p=n.hours?(x=n.hours)==null?void 0:x.toString().padStart(2,"0"):l?"00":"",m=((M=n.minutes)==null?void 0:M.toString().padStart(2,"0"))??"00",k=((V=n.seconds)==null?void 0:V.toString().padStart(2,"0"))??"00";return{element:{[G]:J,key:null,ref:o.value,type:"div",props:{className:"seventv-chat-vod-message-patched"}},msg:t,timestamp:[l,p,m,k].filter(_=>_).join(":")}}return R(()=>{N(i.controller.component,"props"),N(i.list.component,"render"),Z.debug("<Chat/Vod> Unmounted")}),(e,o)=>(h(),b(v,null,[(h(!0),b(v,null,U(g.value,s=>(h(),b(v,{key:s.msg.id},[s&&s.current.current?(h(),T(F,{key:0,to:s.current.current},[I("div",me,[I("span",ue,ee(s.timestamp),1),j(ie,{msg:s.msg,emotes:u(d).active},null,8,["msg","emotes"])])],8,["to"])):D("",!0)],64))),128)),u(y).loaded?(h(),T(le,{key:0})):D("",!0)],64))}});const he=K(de,[["__scopeId","data-v-4934ddca"]]),ge=[X("chat.vods","TOGGLE",{label:"VOD Support",path:["Chat","VODs"],hint:"Enables 7TV rendering in the chat replay of VODs",defaultValue:!0})],fe=O({__name:"ChatVodModule",setup(w){Q("chat-vod",{name:"Chat VOD",depends_on:[]});const i=$("chat.vods"),y=z(Y)??B(""),d=A({parentSelector:".video-chat",maxDepth:20,predicate:c=>c.props&&c.props.children&&c.props.onScrollBottom}),a=A({parentSelector:".chat-shell",maxDepth:20,predicate:c=>c.props&&c.props.comments&&typeof c.props.currentVideoTime=="number"},{trackRoot:!0}),g=B(!1),E=q(g,100);return H(()=>[a.instances,d.instances],([c,S])=>{g.value=c.length===S.length},{immediate:!0}),W(y,()=>{a.instances.length&&d.instances.length||(a.retry(),d.retry())},{debounce:1e3}),(c,S)=>(h(!0),b(v,null,U(u(d).instances,(e,o)=>(h(),b(v,{key:o},[u(E)&&u(i)&&u(d).instances[o]&&u(a).instances[o]?(h(),T(he,{key:0,list:u(d).instances[o],controller:u(a).instances[o]},null,8,["list","controller"])):D("",!0)],64))),128))}}),De=Object.freeze(Object.defineProperty({__proto__:null,config:ge,default:fe},Symbol.toStringTag,{value:"Module"}));export{De as _};
