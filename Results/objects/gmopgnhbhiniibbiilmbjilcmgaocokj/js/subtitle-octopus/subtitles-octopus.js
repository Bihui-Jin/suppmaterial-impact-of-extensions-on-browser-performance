var SubtitlesOctopus=function(e){var t=!1;try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));e instanceof WebAssembly.Module&&(t=new WebAssembly.Instance(e)instanceof WebAssembly.Instance)}}catch(e){console.log("WASM error",e)}console.log("WebAssembly support detected: "+(t?"yes":"no"));var r=this;r.canvas=e.canvas,r.renderMode=e.lossyRender?"fast":e.blendRender?"blend":"normal",r.libassMemoryLimit=e.libassMemoryLimit||0,r.libassGlyphLimit=e.libassGlyphLimit||0,r.targetFps=e.targetFps||void 0,r.isOurCanvas=!1,r.video=e.video,r.canvasParent=null,r.fonts=e.fonts||[],r.availableFonts=e.availableFonts||[],r.onReadyEvent=e.onReady,r.workerUrl=t?e.workerUrl||"subtitles-octopus-worker.js":e.legacyWorkerUrl||"subtitles-octopus-worker-legacy.js";var a=encodeURIComponent(window.chrome&&window.chrome.runtime&&window.chrome.runtime.getURL?window.chrome.runtime.getURL(""):globalThis&&globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.getURL?globalThis.browser.runtime.getURL(""):"/");function n(){var e=r.renderFramesData,t=performance.now();r.ctx.clearRect(0,0,r.canvas.width,r.canvas.height);for(var a=0;a<e.canvases.length;a++){var n=e.canvases[a];r.bufferCanvas.width=n.w,r.bufferCanvas.height=n.h;var s=new Uint8ClampedArray(n.buffer);if(r.hasAlphaBug)for(var o=3;o<s.length;o+=4)s[o]=s[o]>=1?s[o]:1;var i=new ImageData(s,n.w,n.h);r.bufferCanvasCtx.putImageData(i,0,0),r.ctx.drawImage(r.bufferCanvas,n.x,n.y)}if(r.debug){var c=Math.round(performance.now()-t),d=e.blendTime;void 0!==d?console.log("render: "+Math.round(e.spentTime-d)+" ms, blend: "+Math.round(d)+" ms, draw: "+c+" ms; TOTAL="+Math.round(e.spentTime+c)+" ms"):console.log(Math.round(e.spentTime)+" ms (+ "+c+" ms draw)"),r.renderStart=performance.now()}}function s(){var e=r.renderFramesData,t=performance.now();r.ctx.clearRect(0,0,r.canvas.width,r.canvas.height);for(var a=0;a<e.bitmaps.length;a++){var n=e.bitmaps[a];r.ctx.drawImage(n.bitmap,n.x,n.y)}if(r.debug){var s=Math.round(performance.now()-t);console.log(e.bitmaps.length+" bitmaps, libass: "+Math.round(e.libassTime)+"ms, decode: "+Math.round(e.decodeTime)+"ms, draw: "+s+"ms"),r.renderStart=performance.now()}}r.workerUrl+="?path="+a,r.subUrl=e.subUrl,r.subContent=e.subContent||null,r.onErrorEvent=e.onError,r.debug=e.debug||!1,r.lastRenderTime=0,r.pixelRatio=window.devicePixelRatio||1,r.timeOffset=e.timeOffset||0,r.hasAlphaBug=!1,function(){if("function"==typeof ImageData.prototype.constructor)try{return void new window.ImageData(new Uint8ClampedArray([0,0,0,0]),1,1)}catch(e){console.log("detected that ImageData is not constructable despite browser saying so")}var e=document.createElement("canvas").getContext("2d");window.ImageData=function(){var t=0;if(arguments[0]instanceof Uint8ClampedArray)var r=arguments[t++];var a=arguments[t++],n=arguments[t],s=e.createImageData(a,n);return r&&s.data.set(r),s}}(),r.workerError=function(e){if(console.error("Worker error: ",e),r.onErrorEvent&&r.onErrorEvent(e),!r.debug)throw r.dispose(),new Error("Worker error: "+e)},r.init=function(){if(window.Worker){r.worker||(r.worker=new Worker(r.workerUrl),r.worker.onmessage=r.onWorkerMessage,r.worker.onerror=r.workerError),r.workerActive=!1,r.createCanvas(),r.setVideo(e.video),r.setSubUrl(e.subUrl);var t=window.chrome&&window.chrome.runtime&&window.chrome.runtime.getURL?window.chrome.runtime.getURL(""):globalThis&&globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.getURL?globalThis.browser.runtime.getURL(""):"/";r.worker.postMessage({target:"pre-init",browserExtensionPath:t}),r.worker.postMessage({target:"worker-init",width:r.canvas.width,height:r.canvas.height,URL:document.URL,currentScript:r.workerUrl,preMain:!0,renderMode:r.renderMode,subUrl:r.subUrl,subContent:r.subContent,fonts:r.fonts,availableFonts:r.availableFonts,debug:r.debug,targetFps:r.targetFps,libassMemoryLimit:r.libassMemoryLimit,libassGlyphLimit:r.libassGlyphLimit})}else r.workerError("worker not supported")},r.createCanvas=function(){if(r.canvas||(r.video?(r.isOurCanvas=!0,r.canvas=document.createElement("canvas"),r.canvas.className="libassjs-canvas",r.canvas.style.display="none",r.canvasParent=document.createElement("div"),r.canvasParent.className="libassjs-canvas-parent",r.canvasParent.appendChild(r.canvas),r.video.nextSibling?r.video.parentNode.insertBefore(r.canvasParent,r.video.nextSibling):r.video.parentNode.appendChild(r.canvasParent)):r.canvas||r.workerError("Don't know where to render: you should give video or canvas in options.")),r.ctx=r.canvas.getContext("2d"),r.bufferCanvas=document.createElement("canvas"),r.bufferCanvasCtx=r.bufferCanvas.getContext("2d"),!(navigator.userAgent.toLowerCase().indexOf("firefox")>-1)){r.bufferCanvas.width=1,r.bufferCanvas.height=1;var e=new Uint8ClampedArray([0,255,0,0]),t=new ImageData(e,1,1);r.bufferCanvasCtx.clearRect(0,0,1,1),r.ctx.clearRect(0,0,1,1);var a=r.ctx.getImageData(0,0,1,1).data;r.bufferCanvasCtx.putImageData(t,0,0),r.ctx.drawImage(r.bufferCanvas,0,0);var n=r.ctx.getImageData(0,0,1,1).data;r.hasAlphaBug=a[1]!=n[1],r.hasAlphaBug&&console.log("Detected a browser having issue with transparent pixels, applying workaround")}},r.setVideo=function(e){if(r.video=e,r.video){var t=function(){r.setCurrentTime(e.currentTime+r.timeOffset)};r.video.addEventListener("timeupdate",t,!1),r.video.addEventListener("playing",(function(){r.setIsPaused(!1,e.currentTime+r.timeOffset)}),!1),r.video.addEventListener("pause",(function(){r.setIsPaused(!0,e.currentTime+r.timeOffset)}),!1),r.video.addEventListener("seeking",(function(){r.video.removeEventListener("timeupdate",t)}),!1),r.video.addEventListener("seeked",(function(){r.video.addEventListener("timeupdate",t,!1),r.setCurrentTime(e.currentTime+r.timeOffset)}),!1),r.video.addEventListener("ratechange",(function(){r.setRate(e.playbackRate)}),!1),r.video.addEventListener("timeupdate",(function(){r.setCurrentTime(e.currentTime+r.timeOffset)}),!1),r.video.addEventListener("waiting",(function(){r.setIsPaused(!0,e.currentTime+r.timeOffset)}),!1),document.addEventListener("fullscreenchange",r.resizeWithTimeout,!1),document.addEventListener("mozfullscreenchange",r.resizeWithTimeout,!1),document.addEventListener("webkitfullscreenchange",r.resizeWithTimeout,!1),document.addEventListener("msfullscreenchange",r.resizeWithTimeout,!1),window.addEventListener("resize",r.resizeWithTimeout,!1),"undefined"!=typeof ResizeObserver&&(r.ro=new ResizeObserver(r.resizeWithTimeout),r.ro.observe(r.video)),r.video.videoWidth>0?r.resize():r.video.addEventListener("loadedmetadata",(function e(t){t.target.removeEventListener(t.type,e),r.resize()}),!1)}},r.getVideoPosition=function(){var e=r.video.videoWidth/r.video.videoHeight,t=r.video.offsetWidth,a=r.video.offsetHeight,n=t,s=a;return t/a>e?n=Math.floor(a*e):s=Math.floor(t/e),{width:n,height:s,x:(t-n)/2,y:(a-s)/2}},r.setSubUrl=function(e){r.subUrl=e},r.renderFrameData=null,r.workerActive=!1,r.frameId=0,r.isInExtension=function(){return"undefined"!=typeof window&&!!(window.chrome&&window.chrome.runtime&&window.chrome.runtime.id||window.isInExtension||globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id||globalThis.isInExtension)},r.performBackgroundRequest=function(e){const{method:t,url:a,responseType:n}=e,s=e=>{r.worker.postMessage({target:"request-response",url:a,response:e},[e])},o=e=>{r.worker.postMessage({target:"request-response",url:a,error:e})},i=t=>{r.isInExtension()?chrome.runtime.sendMessage({type:8,payload:e},(e=>{if(e.data){const t=new Uint8Array(e.data).buffer;s(t)}else o(e.error)})):o(t)};let c=new XMLHttpRequest;c.open(t,a,!0),c.responseType=n,c.onload=function(){if(200==c.status||0==c.status&&c.response){const e=c.response.slice();s(e)}else i("Invalid status or response")},c.onerror=i,c.send(null)},r.onWorkerMessage=function(e){r.workerActive||(r.workerActive=!0,r.onReadyEvent&&r.onReadyEvent());var t=e.data;switch(t.target){case"fontsloaded":r.onFontsLoaded&&r.onFontsLoaded(t.content);break;case"stdout":console.log(t.content);break;case"console-log":console.log.apply(console,JSON.parse(t.content));break;case"console-debug":console.debug.apply(console,JSON.parse(t.content));break;case"console-info":console.info.apply(console,JSON.parse(t.content));break;case"console-warn":console.warn.apply(console,JSON.parse(t.content));break;case"console-error":console.error.apply(console,JSON.parse(t.content));break;case"stderr":console.error(t.content);break;case"window":window[t.method]();break;case"canvas":switch(t.op){case"getContext":r.ctx=r.canvas.getContext(t.type,t.attributes);break;case"resize":r.resize(t.width,t.height);break;case"renderCanvas":r.lastRenderTime<t.time&&(r.lastRenderTime=t.time,r.renderFramesData=t,window.requestAnimationFrame(n));break;case"renderFastCanvas":r.lastRenderTime<t.time&&(r.lastRenderTime=t.time,r.renderFramesData=t,window.requestAnimationFrame(s));break;case"setObjectProperty":r.canvas[t.object][t.property]=t.value;break;default:throw"eh?"}break;case"tick":r.frameId=t.id,r.worker.postMessage({target:"tock",id:r.frameId});break;case"custom":if(!r.onCustomMessage)throw"Custom message received but client onCustomMessage not implemented.";r.onCustomMessage(e);break;case"setimmediate":r.worker.postMessage({target:"setimmediate"});break;case"get-events":console.log(t.target),console.log(t.events);break;case"get-styles":console.log(t.target),console.log(t.styles);break;case"ready":break;case"request":r.performBackgroundRequest(t);break;default:throw"what? "+t.target}},r.resize=function(e,t,a,n){var s=null;if(a=a||0,n=n||0,(!e||!t)&&r.video){e=(s=r.getVideoPosition()).width*r.pixelRatio,t=s.height*r.pixelRatio;var o=r.canvasParent.getBoundingClientRect().top-r.video.getBoundingClientRect().top;a=s.y-o,n=s.x}e&&t?r.canvas.width==e&&r.canvas.height==t&&r.canvas.style.top==a&&r.canvas.style.left==n||(r.canvas.width=e,r.canvas.height=t,null!=s&&(r.canvasParent.style.position="relative",r.canvas.style.display="block",r.canvas.style.position="absolute",r.canvas.style.width=s.width+"px",r.canvas.style.height=s.height+"px",r.canvas.style.top=a+"px",r.canvas.style.left="50%",r.canvas.style.transform="translate(-50%, 0px)",r.canvas.style.pointerEvents="none"),r.worker.postMessage({target:"canvas",width:r.canvas.width,height:r.canvas.height})):r.video||console.error("width or height is 0. You should specify width & height for resize.")},r.resizeWithTimeout=function(){r.resize(),setTimeout(r.resize,100)},r.runBenchmark=function(){r.worker.postMessage({target:"runBenchmark"})},r.customMessage=function(e,t){t=t||{},r.worker.postMessage({target:"custom",userData:e,preMain:t.preMain})},r.setCurrentTime=function(e){r.worker.postMessage({target:"video",currentTime:e})},r.setTrackByUrl=function(e){r.worker.postMessage({target:"set-track-by-url",url:e})},r.setTrack=function(e){r.worker.postMessage({target:"set-track",content:e})},r.freeTrack=function(e){r.worker.postMessage({target:"free-track"})},r.render=r.setCurrentTime,r.setIsPaused=function(e,t){r.worker.postMessage({target:"video",isPaused:e,currentTime:t})},r.setRate=function(e){r.worker.postMessage({target:"video",rate:e})},r.dispose=function(){r.worker.postMessage({target:"destroy"}),r.worker.terminate(),r.workerActive=!1,r.video&&r.video.parentNode.removeChild(r.canvasParent)},r.createEvent=function(e){r.worker.postMessage({target:"create-event",event:e})},r.getEvents=function(){r.worker.postMessage({target:"get-events"})},r.setEvent=function(e,t){r.worker.postMessage({target:"set-event",event:e,index:t})},r.removeEvent=function(e){r.worker.postMessage({target:"remove-event",index:e})},r.createStyle=function(e){r.worker.postMessage({target:"create-style",style:e})},r.getStyles=function(){r.worker.postMessage({target:"get-styles"})},r.setStyle=function(e,t){r.worker.postMessage({target:"set-style",style:e,index:t})},r.removeStyle=function(e){r.worker.postMessage({target:"remove-style",index:e})},r.init()};"function"==typeof SubtitlesOctopusOnLoad&&SubtitlesOctopusOnLoad(),"undefined"!=typeof exports&&"undefined"!=typeof module&&module.exports&&(exports=module.exports=SubtitlesOctopus);