var RU="ampie.background.core",fL="ampie.tabs.event-handlers",gL="ampie.tabs.monitoring";function jL(a,b){return new pe(null,function(){a:for(var c=a,d=b;;){d=D(d);var e;if(e=d)e=G(d),e=c.La?c.La(e):c.call(null,e);if(q(e))d=Vc(d);else break a}return d},null,null)}function kL(a,b){return new U(null,2,5,V,[Dk(a,b),jL(a,b)],null)}function pL(a){var b=Ri(M([to,!0])),c=z.h(b,to,!1);return null==a?Promise.resolve(null):w(NG).visits.get(a).then(function(d){return OG(d,M([to,c]))})}
function rL(a,b){w(NG).transaction("rw",w(NG).visits,function(){null!=vo.La(b)&&w(NG).visits.where("visitHash").equals(vo.La(b)).modify(function(d){return d.children=Ww(Bd.g(Qo.La(Vw(d)),a))});var c=P.h(b,Ds,a);return w(NG).visits.add(Ww(c))})}
function sL(a,b,c){c=Ri(c);var d=z.h(c,Yn,!0);return w(NG).visits.where("visitHash").anyOf(Ww(a)).and(function(e){return C.g(e.url,b)}).toArray().then(function(e){return ef.g(W,cf.g(function(f){return new U(null,2,5,V,[Ds.La(f),f],null)},Vw(e)))}).then(function(e){var f=G(Gk(function(h){return Ud(e,h)},a)),g=q(d)?ae:e;return g.La?g.La(f):g.call(null,f)})}
function tL(a){for(var b=[],c=arguments.length,d=0;;)if(d<c)b.push(arguments[d]),d+=1;else break;b=2<b.length?new E(b.slice(2),0,null):null;return sL(arguments[0],arguments[1],b)}function vL(a,b){w(NG).visits.where("visitHash").equals(a).modify(function(c){return c.timeSpent+=b})}function wL(a,b){w(NG).visits.update(a,{title:b})}function xL(a,b){w(NG).visits.update(a,{url:b,normalizedUrl:fD(b)})}
function zL(a,b,c){a=new p(null,8,[As,As.La(a),Vq,Vq.La(a),pt,Tp.La(a),wo,wo.La(a),Fs,0,Qo,Cd,vo,b,hs,c],null);var d=Ri(a);b=z.g(d,pt);var e=z.g(d,As);d=z.g(d,vo);b=Oc(new U(null,3,5,V,[b,e,d],null));a=P.h(a,Ds,b);return q(c)?P.h(a,hs,c):P.h(a,hs,b)}
function AL(a){var b=w(RG);b=Ri(b);var c=z.g(b,Ds);b=z.g(b,an);b=((new Date).getTime()-b)/1E3|0;return Mi.g(a,c)?(PH(jr,"ampie.visits",46,new ml(function(){return new U(null,4,5,V,["Switched visit",a,"from",c],null)}),-2022611755),null!=c&&vL(c,b),el(RG,new p(null,2,[Ds,a,an,(new Date).getTime()],null))):null}function pM(a,b){var c=fM.La(a);a=RL.La(a);c=Bd.g(c,b);return new p(null,4,[Ds,b,RL,a,fM,c,HL,Wc],null)}function rM(a,b,c,d){return new p(null,4,[Ds,a,RL,b,fM,c,HL,d],null)}
function qM(a,b){return rM(a,b,new Dd(null,a,null,1,null),Wc)}function sM(a){var b=Ds.La,c=w(w(oM));a=c.La?c.La(a):c.call(null,a);return AL(b.call(Ds,a))}function uM(a,b){return Z.ke(w(oM),P,a,b)}function vM(a,b){PH(dp,eL,83,new ml(function(){return new U(null,3,5,V,["Updating tab",a,b],null)}),-1648118168);return Z.ke(w(oM),P,a,b)}
function wM(a){var b=function(){var c=w(w(oM));return c.La?c.La(a):c.call(null,a)}();return q(b)?(Z.h(w(oM),zi,a),PH(dp,eL,89,new ml(function(){return new U(null,2,5,V,["Removing tab:",b],null)}),1829446399),w(NG).transaction("rw",w(NG).closedTabs,function(){return w(NG).closedTabs.add(Ww(b))})):null}
function xM(a,b){function c(){return w(NG).closedTabs.reverse().limit(e).toArray(function(f){return cf.g(function(g){var h=Ri(M([jM,!0]));h=z.h(h,jM,!1);return zi.g(uk.h(uk.h(Vw(g),fM,Xk),HL,Xk),si(h)?TL:null)},f)})}var d=Ri(M([tr,3])),e=z.h(d,tr,1);return w(NG).transaction("rw",w(NG).visits,w(NG).closedTabs,function(){return c().then(function(f){return sL(cf.g(Ds,f),b,M([Yn,!1])).then(function(g){g=Ri(g);var h=z.g(g,Ds);return new U(null,2,5,V,[g,G(Gk(function(l){return C.g(Ds.La(l),h)},f))],null)})}).then(function(f){var g=
N(f,0,null);f=N(f,1,null);var h=Ri(f);f=z.g(h,TL);h=zi.g(h,TL);null!=g&&(uM(a,h),w(NG).closedTabs.where("objId").equals(f).delete());return null!=g})})}function yM(a,b,c){var d=function(){var g=w(w(oM));return g.La?g.La(a):g.call(null,a)}(),e=Ri(d),f=z.g(e,SL);PH(dp,eL,143,new ml(function(){return new U(null,1,5,V,[e],null)}),-1444724820);PH(dp,eL,144,new ml(function(){return new U(null,3,5,V,[a,b,f],null)}),627269386);xL(b,c);C.g(As.La(f),c)&&wL(b,wo.La(f));return Z.j(w(oM),uk,a,zi,M([SL]))}
var SU=new y(RU,"shortcut-handler","ampie.background.core/shortcut-handler",1428792516,null),TU=new y(null,"shortcut-handler","shortcut-handler",740984981,null),VL=new y(null,"service","service",-322523032,null),XL=new B(null,"ignore","ignore",-1631542033),YL=new B(null,"transition-type","transition-type",616637793),NL=new B(null,"url-updated","url-updated",304252720),OL=new B(null,"transition-qualifiers","transition-qualifiers",-176818038),QL=new B(null,"source-tab-id","source-tab-id",-2045014407),
WL=new B(null,"tab-id","tab-id",-468188778),aM=new y(null,gL,gL,1600857606,null),eM=new B(null,"tabs","tabs",-779855354),iM=new y(gL,"service","ampie.tabs.monitoring/service",1185286338,null),UU=new y(null,RU,RU,507745497,null),nM=new B(null,"active","active",1895962068);function RM(a){a=Vw(a);return P.h(a,Vq,fD(As.La(a)))}function SM(a){var b=WL.La(a),c=function(){var f=w(w(oM));return f.La?f.La(b):f.call(null,b)}(),d=Ds.La(c),e=RL.La(c);a=function(f,g){return C.g(As.La(g),As.La(f))?P.h(f,wo,wo.La(g)):f}(zL(a,d,e),SL.La(c));d=Ds.La(a);e=hs.La(a);c=zi.g(pM(q(c)?c:qM(d,e),d),SL);rL(d,a);return vM(b,c)}function TM(a){return C.g(a,Xw.windows.WINDOW_ID_NONE)?sM(null):null}
function UM(a){var b=WL.La(a),c=Ud(w(w(oM)),b);var d=w(w(oM));d=d.La?d.La(b):d.call(null,b);var e=Ds.La(d),f=RL.La(d);a=zL(a,e,f);e=Ds.La(a);f=hs.La(a);d=c?pM(d,e):qM(e,f);rL(e,a);return c?vM(b,d):uM(b,d)}function VM(a){var b=WL.La(a),c=As.La(a);return xM(b,c).then(function(d){q(d)&&PH(dp,fL,96,new ml(function(){return new U(null,4,5,V,["Restored tab",b,"with url",c],null)}),-149966225);if(si(d)){d=zL(a,null,null);var e=Ds.La(d),f=hs.La(d);f=qM(e,f);rL(e,d);return uM(b,f)}return null})}
function WM(a){var b=WL.La(a),c=As.La(a),d=function(){var g=w(w(oM));return g.La?g.La(b):g.call(null,b)}(),e=fM.La(d),f=HL.La(d);return Promise.all([tL(e,c),tL(f,c)]).then(function(g){var h=g[0],l=g[1];g=kL(function(O){return Mi.g(O,h)},e);var m=N(g,0,null),r=N(g,1,null);g=D(r)?I(m):null;var u=kL(function(O){return Mi.g(O,l)},f),v=N(u,0,null),A=N(u,1,null);u=D(A)?I(v):null;var F=q(g)?null==u||g<u:g,J=si(F)?u:!1;g=si(F)&&si(J);var K=zL(a,Ds.La(d),RL.La(d)),R=function(){var O=new U(null,2,5,V,[Td(F),
Td(J)],null);if(q(function(){var X=new U(null,2,5,V,[!0,!1],null);return C.g?C.g(X,O):C.call(null,X,O)}()))return r;if(q(function(){var X=new U(null,2,5,V,[!1,!0],null);return C.g?C.g(X,O):C.call(null,X,O)}()))return Bd.g(Nk.g(Xk(v),e),G(A));if(q(function(){var X=new U(null,2,5,V,[!1,!1],null);return C.g?C.g(X,O):C.call(null,X,O)}()))return Bd.g(Nk.g(Xk(f),e),Ds.La(K));throw Error(["No matching clause: ",t.La(O)].join(""));}(),S=function(){var O=new U(null,2,5,V,[Td(F),Td(J)],null);if(q(function(){var X=
new U(null,2,5,V,[!0,!1],null);return C.g?C.g(X,O):C.call(null,X,O)}()))return Nk.g(Xk(m),f);if(q(function(){var X=new U(null,2,5,V,[!1,!0],null);return C.g?C.g(X,O):C.call(null,X,O)}()))return Vc(A);if(q(function(){var X=new U(null,2,5,V,[!1,!1],null);return C.g?C.g(X,O):C.call(null,X,O)}()))return Wc;throw Error(["No matching clause: ",t.La(O)].join(""));}();u=G(R);R=rM(u,RL.La(d),R,S);g&&rL(u,K);return vM(b,R)})}
function XM(a,b,c){b=Vw(b);b=Ri(b);z.g(b,wo);b=z.g(b,As);c=Vw(c);c=Ri(c);c=z.g(c,As);fD(c);return q(b)?Xw.tabs.sendMessage(a,rl(new p(null,2,[Ln,NL,As,b],null))).catch(function(){return null}):null}function YM(a,b){a=Ri(a);var c=z.g(a,As),d=z.g(a,WL);b=Ri(b);var e=z.g(b,Ds);PH(dp,fL,185,new ml(function(){return new U(null,4,5,V,["Tab redirect",d,c,e],null)}),-1010151365);return yM(d,e,c)}
function ZM(a,b){PH(dp,fL,192,new ml(function(){return new U(null,3,5,V,["onTabRemoved",a,b],null)}),1139885685);return wM(a)}function $M(a){var b=RM(a);a=WL.La(b);var c=QL.La(b);var d=w(w(oM));d=d.La?d.La(c):d.call(null,c);c=Ds.La(d);d=RL.La(d);b=zL(b,c,d);c=Ds.La(b);d=hs.La(b);d=qM(c,d);rL(c,b);return uM(a,d)}
function aN(a){if(C.g(a.parentFrameId,-1)){a=RM(a);var b=Ri(a),c=z.g(b,As);z.g(b,Vq);var d=z.g(b,WL),e=z.g(b,YL),f=z.g(b,OL);a=pL(Ds.La(function(){var g=w(w(oM));return g.La?g.La(d):g.call(null,d)}()));PH(dp,fL,208,new ml(function(){return new U(null,2,5,V,["Got event:",b],null)}),632097243);PH(dp,fL,209,new ml(function(){return new U(null,2,5,V,["Transition qualifiers:",f],null)}),1627018229);return a.then(function(g){PH(dp,fL,213,new ml(function(){return new U(null,1,5,V,[As.La(g)],null)}),739889284);
return C.g(c,"chrome-search://local-ntp/local-ntp.html")||C.g(c,"chrome://newtab/")||C.g(c,"chrome://new-tab-page/")||Qi(c,"chrome-extension://")||Qi(c,"moz-extension://")?XL:C.g(As.La(g),c)?(PH(dp,fL,225,new ml(function(){return new U(null,1,5,V,["URL is the same, doing nothing"],null)}),1383443080),null):q(Uj(function(h){return C.g("forward_back",h)},f))?WM(b):q(q(g)?C.g(e,"client_redirect")||C.g(e,"link")&&2E3>=(new Date).getTime()-pt.La(g):g)?YM(b,g):C.g(e,"link")||C.g(e,"client_redirect")?SM(b):
C.g(e,"typed")?UM(b):C.g(e,"generated")||C.g(e,"auto_bookmark")?UM(b):C.g(e,"reload")&&!Ud(w(w(oM)),d)?VM(b):(C.g(e,"reload"),null)}).catch(function(g){return PH(ln,fL,259,new ml(function(){return new U(null,3,5,V,["Error while processing event",b,g],null)}),-849287009)})}return null}function bN(a){console.log("History state updated",a);return aN(a)};function cN(){return Xw.windows.getLastFocused({populate:!0}).then(function(a){a=Vw(a);a=Ri(a);var b=z.g(a,eM);a=z.g(a,cM);b=G(Gk(nM,b));b=Ri(b);b=z.g(b,ku);return q(a)?sM(b):sM(null)})}
if(si(AD("#'ampie.tabs.monitoring/service"))){var fN=yD("#'ampie.tabs.monitoring/service");BD(new Rc(function(){return fN},iM,Qj([qh,Rs,vp,wm,Nt,Xl,fm,Xp,gs,Gq],[Id(aM,new p(null,1,[gs,"Keeps track of all the tabs and transitions and\n  saves them to indexeddb."],null)),VL,"ampie/tabs/monitoring.cljs",18,1,89,89,Wc,null,q(fN)?fN.Ga:null])),"#'ampie.tabs.monitoring/service",new p(null,4,[mq,520,nm,function(){return Xw.tabs.onUpdated.addListener(XM)},uh,new Sg(null,new p(null,1,[yp,null],null),null),
Wl,function(){clearInterval(w(fN));Xw.tabs.onUpdated.removeListener(XM);Xw.windows.onFocusChanged.removeListener(TM);Xw.tabs.onRemoved.removeListener(ZM);Xw.webNavigation.onHistoryStateUpdated.removeListener(bN);Xw.webNavigation.onCommitted.removeListener(aN);return Xw.webNavigation.onCreatedNavigationTarget.removeListener($M)}],null))}else fN=zD("#'ampie.tabs.monitoring/service");
Qj([qh,Rs,vp,wm,Nt,Xl,fm,Xp,gs,Gq],[Id(aM,new p(null,1,[gs,"Keeps track of all the tabs and transitions and\n  saves them to indexeddb."],null)),VL,"ampie/tabs/monitoring.cljs",18,1,89,89,Wc,null,q(fN)?fN.Ga:null]);var gN=gl(null);function VU(a){switch(a){case "amplify_page":return zS();case "open_page_context":return Xw.tabs.query({active:!0,currentWindow:!0}).then(function(b){return PE(b,M([Gh,!0]))}).then(function(b){b=N(b,0,null);b=Ri(b);b=z.g(b,As);return DK(new p(null,1,[As,b],null))});case "upvote_page":return IL(new p(null,1,[Ln,bt],null));case "downvote_page":return IL(new p(null,1,[Ln,qv],null));default:throw Error(["No matching clause: ",t.La(a)].join(""));}}
if(si(AD("#'ampie.background.core/shortcut-handler"))){var WU=yD("#'ampie.background.core/shortcut-handler");BD(new Rc(function(){return WU},SU,Qj([qh,Rs,vp,wm,Nt,Xl,fm,Xp,gs,Gq],[UU,TU,"ampie/background/core.cljs",27,1,32,32,Wc,null,q(WU)?WU.Ga:null])),"#'ampie.background.core/shortcut-handler",new p(null,4,[mq,521,nm,function(){return Xw.commands.onCommand.addListener(VU)},uh,new Sg(null,new p(null,1,[yp,null],null),null),Wl,function(){return Xw.commands.onCommand.removeListener(VU)}],null))}else WU=
zD("#'ampie.background.core/shortcut-handler");Qj([qh,Rs,vp,wm,Nt,Xl,fm,Xp,gs,Gq],[UU,TU,"ampie/background/core.cljs",27,1,32,32,Wc,null,q(WU)?WU.Ga:null]);
function hN(){DD();Xw.runtime.onInstalled.addListener(function(a){var b=a.previousVersion;b=fk(sk(parseInt,"0"),Vc($g(/(\d+).(\d+)(?:.(\d+)(?:.(\d+))?)?/,q(b)?b:"0.0.0.0")));console.log("Previous ampie version ",Ru(".",b));C.g(a.reason,"install")&&Xw.tabs.create({url:Xw.runtime.getURL("hello.html")});return C.g(a.reason,"update")?Xw.tabs.create({url:Xw.runtime.getURL("update.html")}):null});null!=w(gN)&&(window.clearInterval(w(gN)),el(gN,null));el(gN,window.setInterval(cN,1E3));Xw.tabs.onUpdated.addListener(XM)}
;try{hN()}catch(a){throw console.error("An error occurred when calling (ampie.background.core/init)"),a;};